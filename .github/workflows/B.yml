name: Batik Recovery A12.1 (No Custom MK)

on:
  workflow_dispatch:
    inputs:
      DEVICE_TREE:
        description: 'm14x A12.1 Tree'
        default: 'https://github.com/nepntt9/android_device_samsung_m14x.git'
      DEVICE_BRANCH:
        description: 'A12.1 Branch'
        default: 'android-12.1'
      DEVICE_NAME:
        description: 'm14x'
        default: 'm14x'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Dependencies
      run: |
        sudo apt update -qq
        sudo apt install -y git repo python3 bc bison flex libssl-dev make ccache curl
        
    - name: Repo Tool
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Setup Repo
      run: |
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod +x ~/.bin/repo
        echo "PATH=${HOME}/.bin:${PATH}" >> $GITHUB_PATH

    - name: TWRP A12.1 Manifest
      run: |
        mkdir ~/batik_a12 && cd ~/batik_a12
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_a12 -b twrp-12.1
        repo sync -c -j$(nproc --all) || repo sync -j4 [attached_file:1]

    - name: Clone m14x Tree **NO MK CHANGES**
      run: |
        cd ~/batik_a12
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_BRANCH }} device/samsung/m14x

    - name: **Use Existing Tree** (No batik_m14x.mk)
      run: |
        cd ~/batik_a12/device/samsung/m14x
        # Verify your existing tree structure
        ls -la AndroidProducts.mk *.mk
        # Ensure twrp_m14x.mk exists (your OFRP tree)
        grep -n "twrp_${{ inputs.DEVICE_NAME }}" AndroidProducts.mk || echo "Using existing makefiles"

    - name: Build (Pure TWRP/Batik Base)
      run: |
        cd ~/batik_a12
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        . build/envsetup.sh
        # Use YOUR existing lunch target from tree
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng
        make clean || true
        mka recoveryimage -j$(nproc --all) || mka recoveryimage -j4

    - name: Package
      run: |
        cp ~/batik_a12/out/target/product/${{ inputs.DEVICE_NAME }}/recovery.img \
          "BatikR-${{ inputs.DEVICE_NAME }}-A12.1-$(date +%Y%m%d-%H%M).img"
        sha256sum BatikR*.img > sha256.txt

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: BatikR-${{ inputs.DEVICE_NAME }}-A12.1
        path: |
          BatikR*.img
          sha256.txt [attached_file:1]
