name: Batik Recovery A12.1 (REPO AUTH FIXED)

on:
  workflow_dispatch:
    inputs:
      DEVICE_TREE:
        default: 'https://github.com/nepntt9/android_device_samsung_m14x.git'
      DEVICE_BRANCH:
        default: 'android-12.1'
      DEVICE_NAME:
        default: 'm14x'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Dependencies
      run: |
        sudo apt update -qq
        sudo apt install -y git python3 bc bison flex libssl-dev make ccache curl
        - name: **REPO + GIT AUTH FIX**
        run: |
        # Official repo launcher
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod +x ~/.bin/repo
        
        # GitHub token for private manifests
        git config --global url "https://${{ secrets.GITHUB_TOKEN }}@github.com/.git/" .gitconfig
        
        export PATH="${HOME}/.bin:${PATH}"
        echo "PATH=${HOME}/.bin:${PATH}" >> $GITHUB_PATH
        repo --version
        - name: **ORANGEFOX-12.1** (Stable A12 - No Auth Issues)
        run: |
        mkdir ~/batik_a12 && cd ~/batik_a12
        # Switch to OrangeFox (public, no GitLab/minimal auth problems)
        git clone https://gitlab.com/OrangeFox/sync.git -b master --depth=1
        cd sync
        ./orangefox_sync.sh --branch 12.1 --path ~/batik_a12/fox_12.1 [web:30]

    - name: Clone m14x Tree
      run: |
        cd ~/batik_a12/fox_12.1
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_BRANCH }} device/samsung/m14x
        - name: **Use Your Tree AS-IS** (No MK mods)
        run: |
        cd ~/batik_a12/fox_12.1/device/samsung/m14x
        echo "âœ… Existing tree: $(ls *.mk)"

    - name: Build
      run: |
        cd ~/batik_a12/fox_12.1
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        source build/envsetup.sh
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng
        mka recoveryimage -j$(nproc --all)

    - name: Package
      run: |
        cp ~/batik_a12/fox_12.1/out/target/product/${{ inputs.DEVICE_NAME }}/recovery.img \
          "BatikR-${{ inputs.DEVICE_NAME }}-A12.1-$(date +%Y%m%d-%H%M).img"
        sha256sum BatikR*.img > sha256.txt

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: BatikR-A12.1-${{ inputs.DEVICE_NAME }}
        path: |
          BatikR*.img
          sha256.txt [attached_file:1]
