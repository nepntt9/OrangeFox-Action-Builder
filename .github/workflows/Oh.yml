name: OrangeFox Stable Build (Fixed) - m14x

# Credits: TeamWin[attached_file:1] | OrangeFox | azwhikaru[attached_file:2]

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Branch'
        required: true
        default: '12.1'
        type: choice
        options:
        - 12.1
        - 11.3
      DEVICE_TREE:
        description: 'Device Tree'
        required: true
        default: 'https://github.com/nepntt9/android_device_samsung_m14x.git'
      DEVICE_TREE_BRANCH:
        description: 'Branch'
        required: true
        default: 'android-12.1'
      DEVICE_PATH:
        description: 'Path'
        required: true
        default: 'device/samsung/m14x'
      DEVICE_NAME:
        description: 'Codename'
        required: true
        default: 'm14x'
      BUILD_TARGET:
        description: 'Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - recovery
        - boot
        - vendorboot

jobs:
  build:
    name: OFRP by ${{ github.actor }}
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main

    - name: 24GB Swap
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24

    - name: Install Repo + Deps **FIX**
      run: |
        # Install repo tool FIRST
        mkdir -p ~/.bin
        PATH="${HOME}/.bin:${PATH}"
        wget -O ~/.bin/repo https://storage.googleapis.com/git-repo-downloads/repo [web:30]
        chmod a+rx ~/.bin/repo
        export PATH="${HOME}/.bin:${PATH}"
        
        sudo apt update -qq
        sudo apt install -y aria2 git-lfs bc bison flex libssl-dev make ccache python3
        
    - name: Sync OrangeFox **FIX**
      run: |
        mkdir -p ~/OrangeFox
        cd ~/OrangeFox
        git clone https://gitlab.com/OrangeFox/sync.git -b master --depth=1
        cd sync
        # Verify repo works
        repo --version
        ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ~/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

    - name: Clone Device Tree
      run: |
        cd ~/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

    - name: Build **FIX**
      run: |
        cd ~/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        source build/envsetup.sh
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng || lunch omni_${{ inputs.DEVICE_NAME }}-eng
        make clean || true
        mka ${{ inputs.BUILD_TARGET }}image -j$(nproc --all) || mka ${{ inputs.BUILD_TARGET }}image -j4

    - name: Outputs
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
        ls -la ~/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/*.img

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ~/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/*.img
          ~/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/*.zip
        name: OFRP ${{ inputs.MANIFEST_BRANCH }} - m14x (${{ env.BUILD_DATE }})
        tag_name: v${{ github.run_id }}
        body: |
          ## OrangeFox Recovery [attached_file:1]
          Build: fox_${{ inputs.MANIFEST_BRANCH }}
          Device: [m14x](${{ inputs.DEVICE_TREE }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          Commit: `${{ env.COMMIT_ID }}` [attached_file:2]
